# ğŸš€ é¡¹ç›®ç»éªŒæ•™è®­ç™»è®°å†Œ (Lessons Learned Registry)

**é¡¹ç›®åç§°**: Log2Weekly (AI Productivity Hub)
**è®°å½•æ—¥æœŸ**: 2026-02-13
**è®°å½•äºº**: AI è¾…åŠ©å¼€å‘åŠ©æ‰‹ (Antigravity)
**ä¸»é¢˜**: Vercel ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ã€CORS è·¨åŸŸä¸å…¨é“¾è·¯è¿é€šæ€§ä¿®å¤

---

## ğŸ›‘ 1. è‡´å‘½é—®é¢˜ï¼šVercel Python Serverless è·¯å¾„è§„èŒƒ

### ğŸ”´ ç°è±¡ (What happened)

- éƒ¨ç½²åè®¿é—® `/api/health` æˆ–ç™»å½•æ¥å£ï¼Œå…¨éƒ¨è¿”å› **404 Not Found** (HTML é¡µé¢)ã€‚
- å‰ç«¯è§£ææŠ¥é”™ï¼š`Unexpected token < in JSON at position 0`ã€‚

### ğŸ” æ ¹å›  (Root Cause)

- **ç›®å½•å‘½åä¸å½“**ï¼šVercel é»˜è®¤è‡ªåŠ¨æ‰«æ `api/` ç›®å½•ä½œä¸º Serverless Functions çš„å…¥å£ï¼Œè€Œæœ¬é¡¹ç›®åŸä½¿ç”¨ `backend/`ã€‚
- **å…¥å£æ–‡ä»¶æ¨¡ç³Š**ï¼šVercel æ¨èä½¿ç”¨ `index.py` ä½œä¸ºé»˜è®¤å…¥å£ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `main.py`ã€‚
- **ç¼ºå°‘åŒ…æ ‡è¯†**ï¼šPython æ¨¡å—å¯¼å…¥å¤±è´¥ï¼Œå› ä¸ºå­ç›®å½•ç¼ºå°‘ `__init__.py`ã€‚

### âœ… è§£å†³æ–¹æ¡ˆ (Solution)

1. **é‡æ„ç›®å½•**ï¼šå°† `backend/` é‡å‘½åä¸º `api/`ã€‚
2. **é‡å‘½åå…¥å£**ï¼šå°† `api/main.py` -> `api/index.py`ã€‚
3. **è¡¥å…¨æ ‡è¯†**ï¼šåœ¨ `api/` åŠ `api/services/` ä¸‹åˆ›å»ºç©ºçš„ `__init__.py`ã€‚
4. **è·¯ç”±é‡å†™ (`vercel.json`)**ï¼š

   ```json
   {
     "rewrites": [{ "source": "/api/(.*)", "destination": "/api/index.py" }]
   }
   ```

---

## ğŸ›‘ 2. å‰ç«¯é™·é˜±ï¼šç¡¬ç¼–ç ä¸ç•¸å½¢ URL æ„é€ 

### ğŸ”´ ç°è±¡

- æœ¬åœ°å¼€å‘ä¸€åˆ‡æ­£å¸¸ï¼Œç”Ÿäº§ç¯å¢ƒç‚¹å‡»ç™»å½•æ— ååº”æˆ–æŠ¥é”™â€œè¿æ¥æœåŠ¡å™¨å¤±è´¥â€ã€‚
- æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤ºè¯·æ±‚åœ°å€ä¸º `https://logs2-weekly.vercel.app/logs2-weekly.vercel.app/api/login` (åŒé‡åŸŸå) æˆ– `localhost:8000`ã€‚

### ğŸ” æ ¹å› 

1. **ç¡¬ç¼–ç æ®‹ä½™**ï¼šç»„ä»¶ (`LoginView.tsx`) ä¸­ç›´æ¥å†™æ­»äº† `http://localhost:8000`ï¼Œæœªèµ°ç»Ÿä¸€é…ç½®ã€‚
2. **åŸºå‡†è·¯å¾„é€»è¾‘æ¼æ´**ï¼š`aiService.ts` è¯•å›¾æ™ºèƒ½åˆ¤æ–­ `VITE_API_BASE_URL`ï¼Œä½†åœ¨ Vercel ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè‹¥ç¯å¢ƒå˜é‡ä¸å½“å‰åŸŸåæ‹¼æ¥ä¸å½“ï¼Œä¼šå¯¼è‡´ç›¸å¯¹è·¯å¾„è¢«é”™è¯¯è§£æä¸ºâ€œå½“å‰è·¯å¾„ + åŸŸåâ€ã€‚

### âœ… è§£å†³æ–¹æ¡ˆ

- **ç»Ÿä¸€å¯»å€**ï¼šæ‰€æœ‰ç»„ä»¶ç¦æ­¢å‡ºç° URL å­—ç¬¦ä¸²ï¼Œç»Ÿä¸€å¼•å…¥ `API_BASE_URL` å¸¸é‡ã€‚
- **ç›¸å¯¹è·¯å¾„ä¼˜å…ˆ**ï¼šåœ¨åŒåŸŸéƒ¨ç½²æ¨¡å¼ä¸‹ï¼ˆå‰ç«¯åç«¯éƒ½åœ¨ Vercelï¼‰ï¼Œç›´æ¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„ `/api` æ˜¯æœ€ç¨³å¦¥çš„ï¼Œèƒ½è‡ªåŠ¨é€‚é… http/https å’Œä»»ä½•åŸŸåã€‚

  ```typescript
  // aiService.ts (Fix)
  export const API_BASE_URL = "/api"; 
  ```

---

## ğŸ›‘ 3. éšå½¢æ€æ‰‹ï¼šCORS è·¨åŸŸä¸æµè§ˆå™¨å®‰å…¨ç­–ç•¥

### ğŸ”´ ç°è±¡

- ä½¿ç”¨ `curl` æˆ– Postman æµ‹è¯•ç”Ÿäº§æ¥å£ **HTTP 200 æˆåŠŸ**ã€‚
- **æµè§ˆå™¨** è®¿é—®åŒä¸€æ¥å£æŠ¥é”™ `Network Error` æˆ– `Failed to fetch`ã€‚
- æ§åˆ¶å°æ— è¯¦ç»†åç«¯æ—¥å¿—ï¼ˆè¯·æ±‚ç”šè‡³æœªåˆ°è¾¾åç«¯ä¸šåŠ¡é€»è¾‘ï¼‰ã€‚

### ğŸ” æ ¹å› 

- **æ··ç”¨é€šé…ç¬¦**ï¼šFastAPI çš„ `CORSMiddleware` é…ç½®äº† `allow_origins=["*"]` åŒæ—¶å¼€å¯äº† `allow_credentials=True`ã€‚
- **æ ‡å‡†å†²çª**ï¼šç°ä»£æµè§ˆå™¨å®‰å…¨è§„èŒƒç¦æ­¢åœ¨å…è®¸ `Access-Control-Allow-Credentials: true` çš„åŒæ—¶ä½¿ç”¨é€šé…ç¬¦ `*` ä½œä¸º `Access-Control-Allow-Origin`ã€‚é¢„æ£€è¯·æ±‚ (`OPTIONS`) å¤±è´¥ï¼Œä¸»è¯·æ±‚è¢«æµè§ˆå™¨ç›´æ¥æ‹¦æˆªã€‚

### âœ… è§£å†³æ–¹æ¡ˆ

- **ç”Ÿäº§çº§ç­–ç•¥**ï¼šè‹¥éœ€æ”¯æŒ Cookie/å‡­è¯ï¼Œå¿…é¡»æŒ‡å®šå…·ä½“åŸŸåã€‚
- **å¿«é€Ÿä¿®å¤ç­–ç•¥**ï¼šè‹¥æš‚æ—  Cookie éœ€æ±‚æˆ–éœ€å¿«é€Ÿè·‘é€šï¼Œä¿æŒé€šé…ç¬¦ä½†å…³é—­å‡­è¯è®¸å¯ã€‚

  ```python
  app.add_middleware(
      CORSMiddleware,
      allow_origins=["*"],
      allow_credentials=False, # å…³é”®ä¿®æ­£
      allow_methods=["*"],
      allow_headers=["*"],
  )
  ```

---

## ğŸ’¡ æœ€ä½³å®è·µæ€»ç»“ (Takeaways)

1. **éƒ¨ç½²å³æµ‹è¯•**ï¼šä¸è¦ä¿¡ä»»æœ¬åœ°ç¯å¢ƒçš„è¿é€šæ€§ï¼Œ`localhost` ä¸ Serverless è¿è¡Œç¯å¢ƒå·®å¼‚å·¨å¤§ã€‚
2. **æ—¥å¿—åˆ†çº§**ï¼šå‰ç«¯ `catch` å—ä¸­å¿…é¡»ä¿ç•™ `console.error`ï¼Œå¦åˆ™ç”Ÿäº§ç¯å¢ƒå‡ºç°â€œé™é»˜å¤±è´¥â€æ—¶æ— æ³•ä»æ§åˆ¶å°è·å–çº¿ç´¢ã€‚
3. **å·¥å…·éªŒè¯äº’è¡¥**ï¼š
   - `curl`/Postmanï¼šéªŒè¯åç«¯ä»£ç é€»è¾‘å’Œæ•°æ®åº“è¿æ¥ã€‚
   - æµè§ˆå™¨æ§åˆ¶å°ï¼šéªŒè¯ CORSã€ç½‘ç»œåè®® HTTPSã€Mixed Content é—®é¢˜ã€‚
   - **ä¸¤è€…ç¼ºä¸€ä¸å¯**ã€‚
4. **ä¾èµ–é”å®š**ï¼šæœ¬åœ° Python ç¯å¢ƒå®½æ¾ï¼ŒServerless ç¯å¢ƒä¸¥æ ¼ã€‚åŠ¡å¿…ç¡®ä¿ `requirements.txt` åŒ…å«æ‰€æœ‰éšå¼ä¾èµ–ï¼ˆå¦‚æœ¬æ¬¡æ¼æ‰çš„ `email-validator`ï¼‰ã€‚

---

> **ä¸‹æ¬¡è¡ŒåŠ¨æŒ‡å—**:
>
> - é‡åˆ° 404 -> æŸ¥ `vercel.json` å’Œç›®å½•ç»“æ„ã€‚
> - é‡åˆ° Network Error -> æŸ¥ CORS å’Œ `API_BASE_URL`ã€‚
> - é‡åˆ° 500 (Server Error) -> æŸ¥ Vercel Function Logs å’Œ `requirements.txt`ã€‚
